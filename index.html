<html>
<head>
  <title>torrentify!</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css"> <!-- load bootstrap via CDN -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script> <!-- load jquery via CDN -->
  <style>
    .container {
      width: 500px;
    }
  </style>
</head>
<body>
  <div class="container center-block text-center">
    <h2>Torrentify!</h2>
      <ol style="width: 250px; margin-left: auto; margin-right: auto;">
	<li>Enter URL to file</li>
	<li>Torrentify!</li>
	<li>Download torrent</li>
      </ol>
    <div id="name-group" class="form-group">
      <label for="url">URL to file</label>
      <input type="text" class="form-control" name="url"
             placeholder="http://yann.lecun.com/exdb/mnist/t10k-images-idx3-ubyte.gz">
    </div>
    <div class="row center-block">
      <div class="col-xs-6">
	<button type="submit" style="width:100%" class="btn btn-primary" id="torrentify">Torrentify!</button>
      </div>
      <div class="col-xs-6">
	<a><button type="submit" style="width:100%" class="btn btn-primary disabled" id="download">Download Torrent!</button></a>
      </div>
    </div>
    <br/>
    <div class="progress progress-striped active">
      <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
      </div>
      <div class="">
      </div>
    </div>
  </div>
</body>
<script>
url = null;
basename = null;
poll = null;

poll_status = function() {
  $.get('query.php', {'url': url}).done(function(data) {
    data = JSON.parse(data);
    console.log(data);
    if (data['status']!='ERROR'){
      current = parseInt(data.progress.split('/')[0]);
      total = parseInt(data.progress.split('/')[1]);
      value = current/total * 100;
      $('.progress-bar').css('width', (current/total*100)+'%').attr('aria-valuenow', value);
      $('.progress-bar').text(data['progress'] + ' bytes processed.');
      if (current==total) {
        clearInterval(poll);
        $('#torrentify').removeClass('disabled');
        $('#download').removeClass('disabled');
        $("a").attr("href", "torrents/" + basename + ".torrent");
        console.log('done!');
      }
    } else {
      clearInterval(poll);
      alert("Bad URL!");
      $('#torrentify').removeClass('disabled');
    }
  });
}

$(document).ready(function() {
  // form submission
  $('#torrentify').click(function(event) {
    $('.form-group').removeClass('has-error');
    $('.help-block').remove();

    url = $('input[name=url]').val();
    basename = url.split("/").slice(-1)[0];
    $.get('create.php', {'url': url});

    setTimeout(function(){
      $('#torrentify').addClass('disabled');

      // begin polling
      poll = setInterval(poll_status, 1000);
    }, 2000);
  });
});
</script>
</html>
